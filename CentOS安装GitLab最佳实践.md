# 环境

```shell

[root@iZ2851te7e5Z ~]# lsb_release -a
LSB Version:	:core-4.1-amd64:core-4.1-noarch
Distributor ID:	CentOS
Description:	CentOS Linux release 7.1.1503 (Core)
Release:	7.1.1503
Codename:	Core

```

服务器安装了

- PHP7
- Nginx,占用80端口
- Mysql

# 安装


### postfix 不能启动
```
 /usr/sbin/postconf: fatal: parameter inet_interfaces: no local interface found for ::1
```

修改配置文件 `vi /etc/postfix/main.cf`

修改的部分为
```
inet_interfaces = 127.0.0.1 #只能接受内部邮件，其它邮件不接受

inet_protocols = all
```

启动服务 `sudo systemctl start postfix`,成功.

## 添加GitLab安装包到服务器

`curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash`

### 添加国内的镜像源

执行上面的命令,会一直 time out ,所以我们要换成国内的源.
 
以下操作针对CentOS 7 ,其他的请戳 [https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/](https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/)

`vim /etc/yum.repos.d/gitlab-ce.repo`

```
[gitlab-ce]
name=gitlab-ce
baseurl=http://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7
repo_gpgcheck=0
gpgcheck=0
enabled=1
gpgkey=https://packages.gitlab.com/gpg.key
```

注意,如果对应配置文件下有文件`gitlab_gitlab-ce.repo`,重命名一下,不然会默认加载这个导致上面的文件不起作用.

查看目前的yum进程,并杀死

```
 ps -a
  PID TTY          TIME CMD
18781 pts/0    00:00:00 sudo
18783 pts/0    00:00:00 bash
18796 pts/0    00:00:00 yum
18855 pts/0    00:00:00 sudo
18856 pts/0    00:00:00 yum
18871 pts/0    00:00:00 ps

kill -9 18796
kill -9 18856

```

```
sudo yum makecache
sudo yum install gitlab-ce 
```

上面执行完了,是这样的展示结果

```
sudo gitlab-ctl reconfigure

gitlab: GitLab should be reachable at http://iZ2851te7e5Z
gitlab: Otherwise configure GitLab for your system by editing /etc/gitlab/gitlab.rb file
gitlab: And running reconfigure again.
gitlab: 
gitlab: For a comprehensive list of configuration options please see the Omnibus GitLab readme
gitlab: https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md
gitlab: 
It looks like GitLab has not been configured yet; skipping the upgrade script.
  验证中      : gitlab-ce-8.7.6-ce.0.el7.x86_64                                                                                         1/1 

已安装:
  gitlab-ce.x86_64 0:8.7.6-ce.0.el7                                                                                                         

完毕！

```



## 配置和开始使用GitLab


`sudo gitlab-ctl reconfigure`

接下来会自动配置文件权限,安装数据库....

提示!安装的时间会很长!!!

<del>根据我们服务器监控记录,配置过程花了5个小时!</del>

# 使用

## 查看状态

上面的命令是通过`gitlab-ctl`安装的,那么通过`gitlab-ctl`命令一样也能做别事情~

`gitlab-ctl`

```shell

I don't know that command.
/opt/gitlab/embedded/bin/omnibus-ctl: command (subcommand)
deploy-page
  Put up the deploy page
remove-accounts
  Delete *all* users and groups used by this package
upgrade
  Run migrations after a package upgrade
General Commands:
  cleanse
    Delete *all* gitlab data, and start from scratch.
  help
    Print this help message.
  reconfigure
    Reconfigure the application.
  show-config
    Show the configuration that would be generated by reconfigure.
  uninstall
    Kill all processes and uninstall the process supervisor (data will be preserved).
Service Management Commands:
  graceful-kill
    Attempt a graceful stop, then SIGKILL the entire process group.
  hup
    Send the services a HUP.
  int
    Send the services an INT.
  kill
    Send the services a KILL.
  once
    Start the services if they are down. Do not restart them if they stop.
  restart
    Stop the services if they are running, then start them again.
  service-list
    List all the services (enabled services appear with a *.)
  start
    Start services if they are down, and restart them if they stop.
  status
    Show the status of all the services.
  stop
    Stop the services, and do not restart them.
  tail
    Watch the service logs of all enabled services.
  term
    Send the services a TERM.

```

这样就知道了我们的服务怎么使用了~

## status 查看状态

```
# gitlab-ctl status
run: gitlab-workhorse: (pid 19751) 23124s; run: log: (pid 19750) 23124s
run: logrotate: (pid 31160) 1078s; run: log: (pid 19765) 23091s
run: nginx: (pid 32621) 0s; run: log: (pid 19755) 23119s
run: postgresql: (pid 19584) 23964s; run: log: (pid 19583) 23964s
run: redis: (pid 19501) 23975s; run: log: (pid 19500) 23975s
run: sidekiq: (pid 19831) 22616s; run: log: (pid 19738) 23128s
run: unicorn: (pid 19707) 23134s; run: log: (pid 19706) 23134s
```

## tail 查看日志

这个命令查看我们的gitlab在运行过程中有没有问题.

`gitlab-ctl tail`

还真的出现了问题.

### 80端口占用问题

`bind() to 0.0.0.0:80 failed (98: Address already in use)`

很显然,由于我们的服务器已经采用了nginx,并且已经使用了80端口,导致这部分出错.

```
# service nginx restart
Restarting nginx (via systemctl):  Job for nginx.service failed. See 'systemctl status nginx.service' and 'journalctl -xn' for details
```

#### 修改配置文件

`vim /var/opt/gitlab/nginx/conf/gitlab-http.conf`

改成

```


```

# 参考资料

- https://about.gitlab.com/gitlab-com/


- http://www.chhua.com/web-note4929
- https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/